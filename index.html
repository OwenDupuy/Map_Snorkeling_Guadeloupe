<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Les meilleurs spots de Snorkeling en Guadeloupe</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    /* Taille de la carte */
    #map {
      height: 100vh;
      width: 100%;
    }

    /* --- L√©gende (agrandie + fond blanc) --- */
    .legend {
      background: white;
      padding: 15px;
      border-radius: 10px;
      font-size: 1.4em;
      line-height: 1.6em;
      box-shadow: 0 0 12px rgba(0,0,0,0.3);
    }

    .legend b {
      font-size: 1.2em;
    }

    .legend i {
      width: 20px !important;
      height: 20px !important;
      border-radius: 50%;
      margin-right: 10px;
      display: inline-block;
    }

    /* --- Marqueurs personnalis√©s color√©s --- */
    .custom-marker {
      border-radius: 50%;
      border: 2px solid #ffffff;
      box-shadow: 0 0 8px rgba(0,0,0,0.4);
    }

    .rating-5 { background: #1a9850; }
    .rating-4 { background: #66bd63; }
    .rating-3 { background: #c8ffb5; }
    .rating-2 { background: #fee08b; }
    .rating-1 { background: #d73027; }

    .slider {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: 5px;
    }

    .slider-btn {
      border: none;
      background: rgba(0,0,0,0.6);
      color: white;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .slider-btn:hover {
      background: rgba(0,0,0,0.8);
    }

    .slider-counter {
      text-align: center;
      font-size: 0.9em;
      margin-top: 2px;
      color: #333;
    }

    #filters-box {
      position: absolute;
      left: 10px;
      top: 240px;              /* ‚âà sous la barre de recherche */
      background: white;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0,0,0,0.3);
      font-size: 1.1em;
      z-index: 999;           /* au-dessus de la carte et des tuiles */
    }

    /* Bouton d‚Äôen-t√™te (ligne "Filtres ‚ñæ") */
    .filters-header {
      width: 100%;
      background: transparent;
      border: none;
      padding: 0;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
    }

    /* Fl√®che anim√©e */
    .filters-arrow {
      display: inline-block;
      transition: transform 0.2s ease;
    }

    .filters-arrow.open {
      transform: rotate(180deg); /* fl√®che vers le haut */
    }

    /* Contenu (les cases √† cocher) */
    #filters-content {
      margin-top: 8px;
    }

    #filters-content.hidden {
      display: none;
    }

    #filters-content label {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;
      font-size: 0.95em;
    }

    #filters-content input {
      margin: 0;
    }

    #filters-box h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 1.1em;
    }
    #filters-box label {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-search@4.0.0/dist/leaflet-search.min.css">

</head>
  
<body>

  <div id="filters-box">
    <button id="filters-toggle" class="filters-header">
      <span>Filtres</span>
      <span class="filters-arrow">‚ñæ</span>
    </button>

    <div id="filters-content" class="hidden">
      <label><input type="checkbox" data-rating="5" checked> 5 ‚òÖ Parfait</label>
      <label><input type="checkbox" data-rating="4" checked> 4 ‚òÖ Tr√®s bien</label>
      <label><input type="checkbox" data-rating="3" checked> 3 ‚òÖ Bien</label>
      <label><input type="checkbox" data-rating="2" checked> 2 ‚òÖ Neutre</label>
      <label><input type="checkbox" data-rating="1" checked> 1 ‚òÖ Mauvais</label>

      <hr style="margin:8px 0;">

      <label><input type="checkbox" data-species="tortue"> Tortues üê¢</label>
      <label><input type="checkbox" data-species="requin"> Requins ü¶à</label>
    </div>

  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-search@4.0.0/dist/leaflet-search.min.js"></script>

  <script>
    /* ----------------------------------------------------------
       1. D√©finir les limites autour de la Guadeloupe
    ----------------------------------------------------------- */
    const guadeloupeBounds = L.latLngBounds(
      [15.7, -62.1],   // sud-ouest
      [16.6, -60.9]    // nord-est
    );

    /* ----------------------------------------------------------
       2. Cr√©ation de la carte + blocages de d√©placement
    ----------------------------------------------------------- */
    const map = L.map('map', {
      center: [16.265, -61.551],
      zoom: 10,
      maxBounds: guadeloupeBounds,
      maxBoundsViscosity: 1.0
    });

    // üëâ Nouveau : layer qui contiendra tous les markers
    const markersLayer = L.layerGroup().addTo(map);


    /* ----------------------------------------------------------
       3. Tuiles (fonds de carte)
    ----------------------------------------------------------- */
    const satellite = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: 'Tiles ¬© Esri ‚Äî Source: Esri, USDA, USGS, GeoEye, etc.' }
    );
    
    const osm = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution: '¬© OpenStreetMap contributors' }
    );

    const relief = L.tileLayer(
      'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
      { attribution: '¬© OpenTopoMap (CC-BY-SA)' }
    );

    // Couche par d√©faut
    satellite.addTo(map);

    /* ----------------------------------------------------------
       4. Contr√¥le permettant de changer de fond de carte
    ----------------------------------------------------------- */
    const baseLayers = {
      "Satellite": satellite,
      "Classique (OSM)": osm,
      "Relief": relief
    };

    L.control.layers(baseLayers, null, {
      position: 'topleft',
      collapsed: false
    }).addTo(map);

    /* ----------------------------------------------------------
       5. Fonctions utilitaires pour couleurs + √©toiles
    ----------------------------------------------------------- */
    function getColor(rating) {
      switch (rating) {
        case 5: return "#1a9850";
        case 4: return "#66bd63";
        case 3: return "#c8ffb5";
        case 2: return "#fee08b";
        case 1: return "#d73027";
        default: return "#888";
      }
    }

    function getStars(rating) {
      return "‚òÖ".repeat(rating) + "‚òÜ".repeat(5 - rating);
    }

    /* ----------------------------------------------------------
       6. Spots (√† adapter avec tes vrais lieux + photos)
    ----------------------------------------------------------- */
    const spots = [
      {
        name: "Malendure, Bouillante",
        coords: [16.1726, -61.7791],       // plage de Malendure :contentReference[oaicite:0]{index=0}
        desc: "Lieu de r√™ve pour croiser des tortues. Il faut rejoindre la petite plage au nord de la plage principale de Malendure pour maximiser ses chances d‚Äôen voir en milieu sauvage. On peut √©galement observer des torpilles et des barracudas. La visibilit√© est globalement bonne.",
        rating: 4,
        species: ["tortue"],
        images: ["images/malendure1.JPG","images/malendure2.JPG","images/malendure3.JPG","images/malendure4.jpg","images/malendure5.jpg","images/malendure6.jpg","images/malendure7.jpg","images/malendure8.jpg"]
      },
      {
        name: "Bosco, Deshaies",
        coords: [16.2864, -61.8027],    // plage Bosco / Paul Thomas :contentReference[oaicite:1]{index=1}
        desc: "Lieu calme et un peu secret. On y acc√®de en contournant un portail pr√©sent√© comme une r√©sidence priv√©e. Beaucoup de crabes touloulous, une tr√®s bonne visibilit√© et une grande richesse aquatique de part et d‚Äôautre de la plage.",
        rating: 5,
        species: ["tortue"],
        images: ["images/bosco1.jpg","images/bosco2.jpg","images/bosco3.jpg","images/bosco4.jpg","images/bosco5.jpg","images/bosco6.jpg","images/bosco7.jpg","images/bosco8.jpg","images/bosco9.jpg"]
      },
      {
        name: "Anse de Deshaies, Deshaies",
        coords: [16.3075, -61.7966],      // zone Deshaies littoral :contentReference[oaicite:2]{index=2}
        desc: "Beaucoup de bateaux et un peu de turbidit√©, mais pr√©sence de poissons-globes et de tortues. Spot prot√©g√© des vagues et plut√¥t calme. Coin agr√©able avec en bonus un excellent restaurant, ‚ÄúL‚ÄôAmer‚Äù, tout proche.",
        rating: 2,
        species: ["tortue"],
        images: []
      },
      {
        name: "Ravine Thomas, Bouillante",
        coords: [16.1095, -61.7747],      // commune Bouillante :contentReference[oaicite:3]{index=3}
        desc: "Biodiversit√© de r√™ve entre nudibranches et serpentines. Site riche en vie et en couleurs, avec de beaux coquillages et une grande diversit√© d‚Äôesp√®ces tout au long de l‚Äôexploration. Proximit√© de bassins d‚Äôeaux thermales.",
        rating: 4,
        species: ["tortue"],
        images: ["images/ravine_thomas1.jpg","images/ravine_thomas2.jpg","images/ravine_thomas3.jpg","images/ravine_thomas4.jpg","images/ravine_thomas5.jpg","images/ravine_thomas6.JPG","images/ravine_thomas7.jpg","images/ravine_thomas8.jpg","images/ravine_thomas9.jpg","images/ravine_thomas10.jpg"]
      },
      {
        name: "Anse √† la Barque, Bouillante",
        coords: [16.0893, -61.7688],      // estimation proche Bouillante
        desc: "Lieu prot√©g√© des vagues, calme et avec peu de bateaux. Bon nombre d‚Äôesp√®ces, notamment plusieurs pieuvres. Environnement de roches am√©nag√©es par l‚Äôhumain, avec pr√©sence de mangroves puis de falaises au bout de l‚Äôanse.",
        rating: 3,
        species: ["tortue"],
        images: ["images/anse_a_la_barque1.JPG","images/anse_a_la_barque2.jpg","images/anse_a_la_barque3.jpg","images/anse_a_la_barque4.jpg","images/anse_a_la_barque5.jpg","images/anse_a_la_barque6.jpg"]
      },
      {
        name: "Petite Terre, Terre-de-Bas",
        coords: [16.1747, -61.1092],      // estimation Petite-Terre
        desc: "V√©ritable nurserie de requins-citrons et de tortues. Le site est connu pour les requins-citrons juv√©niles, les raies pastenagues et, avec un peu de chance, les requins dormeurs et les raies aigles. C‚Äôest une r√©serve naturelle avec beaucoup de r√®gles en vigueur. Forte pr√©sence d‚Äôiguanes √† terre et coraux plut√¥t ab√Æm√©s dans la zone fr√©quent√©e. La zone accessible au public se situe entre les deux √Æles, le reste est interdit.",
        rating: 5,
        species: ["tortue", "requin"],
        images: ["images/petite_terre1.jpg","images/petite_terre2.jpg","images/petite_terre3.jpg","images/petite_terre4.jpg","images/petite_terre5.jpg","images/petite_terre6.jpg","images/petite_terre7.jpg","images/petite_terre8.jpg","images/petite_terre9.jpg"]
      },
      {
        name: "Trou Man Louis, Anse-Bertrand",
        coords: [16.4861, -61.4972],      // estimation Port-Louis c√¥te Est
        desc: "Endroit paradisiaque, mais il faut faire attention : en cas de vagues, le snorkeling devient tr√®s difficile. Eau transparente et chaude, avec de nombreux poissons color√©s √† observer.",
        rating: 3,
        species: [],
        images: ["images/trou_man_louis1.JPG","images/trou_man_louis2.jpg"]
      },
      {
        name: "√élets du Gosier, Le Gosier",
        coords: [16.2000, -61.4921],      // estimation Le Gosier
        desc: "Site tr√®s d√©grad√© avec un fort impact anthropique. La balade autour de l‚Äô√Ælet est sympa, mais ce n‚Äôest pas un spot int√©ressant pour le snorkeling.",
        rating: 1,
        species: [],
        images: []
      },
      {
        name: "Malendure, Bouillante",
        coords: [16.1691, -61.7776],       // identique √† Malendure plage
        desc: "Au pied du club de plong√©e ‚ÄúLes Heures Saines‚Äù se trouve le dortoir des tortues vertes et imbriqu√©es locales. Sortie conseill√©e de nuit. Grande richesse d‚Äôesp√®ces et de coraux entre les gros blocs rocheux.",
        rating: 4,
        species: ["tortue"],
        images: ["images/malendure_night1.jpg","images/malendure_night2.jpg","images/malendure_night3.jpg","images/malendure_night4.jpg","images/malendure_night5.jpg","images/malendure_night6.JPG","images/malendure_night7.jpg","images/malendure_night8.jpg","images/malendure_night9.jpg","images/malendure_night10.jpg","images/malendure_night11.jpg","images/malendure_night12.jpg","images/malendure_night13.jpg"]
      },
      {
        name: "√élets Pigeon (R√©serve Cousteau), Bouillante",
        coords: [16.1674, -61.7895],      // coord. R√©serve Cousteau :contentReference[oaicite:4]{index=4}
        desc: "Acc√®s en kayak, eau transparente et grande zone d‚Äôexploration. Pr√©sence de nombreux poissons balistes (non agressifs). Potentiel d‚Äôexploration encore important.",
        rating: 5,
        species: ["tortue"],
        images: ["images/reserve_cousteau1.jpg","images/reserve_cousteau2.JPG","images/reserve_cousteau3.jpg"]
      },
      {
        name: "Plage de Leroux, Deshaies",
        coords: [16.2769, -61.8050],      // proche plage Bosco / Leroux :contentReference[oaicite:5]{index=5}
        desc: "Un des meilleurs endroits en termes d‚Äô√©quilibre entre calme, beaut√© et qualit√© de snorkeling. L‚Äô√©pi central est tr√®s riche en biodiversit√©, m√™me si la zone reste assez petite. Le reste est un peu plus d√©grad√©, mais une apr√®s-midi sur cette plage est fortement conseill√©e.",
        rating: 3,
        species: ["tortue"],
        images: ["images/plage_leroux1.jppg.JPG","images/plage_leroux2.jpg","images/plage_leroux3.jpg","images/plage_leroux4.jpg","images/plage_leroux5.jpg","images/plage_leroux6.jpg","images/plage_leroux7.JPG"]
      },
      {
        name: "Plage du Souffleur, Port-Louis",
        coords: [16.4258, -61.5353],      // estimation Port-Louis
        desc: "Fond plut√¥t d√©grad√© et pollu√© par des r√©sidus de filets de p√™che et quelques plastiques sur le sable. L‚Äôeau reste belle avec quelques poissons, mais il y a relativement peu √† voir compar√© √† d‚Äôautres sites. Plage tr√®s fr√©quent√©e et tr√®s jolie.",
        rating: 2,
        species: [],
        images: ["images/plage_du_souffleur1.jpg","images/plage_du_souffleur2.jpg"]
      },
      {
        name: "Plage d‚ÄôAntigues, Port-Louis",
        coords: [16.4369, -61.5386],      // estimation c√¥te Est
        desc: "Semblable √† la tr√®s connue plage du Souffleur, mais plus excentr√©e, donc plus calme et moins fr√©quent√©e. Plus de pr√©sence d‚Äôherbiers marins, avec possibilit√© d‚Äôobserver des raies et des requins juv√©niles.",
        rating: 3,
        species: ["requin"],
        images: ["images/plage_antigues1.jpg","images/plage_antigues2.jpg","images/plage_antigues3.jpg","images/plage_antigues4.jpg"]
      },
      {
        name: "Anse des Rochers, Saint-Fran√ßois",
        coords: [16.2417, -61.3064],      // estimation St-Fran√ßois c√¥t√© Est
        desc: "Site accessible via une r√©sidence / centre de vacances. Tr√®s belle plage, s√©curis√©e et prot√©g√©e des vagues. Principalement des esp√®ces juv√©niles qui se cachent dans les herbiers et les petits amas de roches.",
        rating: 2,
        species: [],
        images: []
      },
      {
        name: "Les Trois Pointes, Vieux-Fort",
        coords: [15.9556, -61.7105],      // estimation Vieux-Fort sud Basse-Terre
        desc: "Riche en couleurs et en biodiversit√©, avec des bleus marins magnifiques et de nombreuses esp√®ces pr√©sentes. Attention aux possibles mouvements d‚Äôeau. Lieu recul√©, tr√®s agr√©able √† explorer en immersion compl√®te.",
        rating: 4,
        species: ["tortue"],
        images: ["images/les_trois_pointes1.JPG","images/les_trois_pointes2.jpg","images/les_trois_pointes3.jpg"]
      },
      {
        name: "Morphy, Pointe-Noire",
        coords: [16.2527, -61.8043],      
        desc: "Lieu l√©g√®rement expos√© √† la houle de la mer des Cara√Øbes. Excellent spot de plong√©e et tr√®s bon endroit pour le snorkeling. Les reliefs sous-marins y sont nombreux, avec une belle diversit√© de couleurs et d‚Äôesp√®ces. Plage de galets, pente douce qui descend r√©guli√®rement jusqu‚Äô√† environ 30 m√®tres de profondeur.",
        rating: 4,
        species: ["tortue"],
        images: ["images/morphy1.JPG","images/morphy2.JPG","images/morphy3.JPG","images/morphy4.JPG","images/morphy5.JPG","images/morphy6.JPG"]
      },
      {
        name: "Plage de la R√©sidence D√©partementale, Le Gosier",
        coords: [16.2147, -61.5160],      
        desc: "Petite plage situ√©e au pied du fort. L‚Äôendroit est charmant et un peu escarp√©, mais la visibilit√© est tr√®s mauvaise : les vagues remuent constamment le sable, ce qui emp√™che toute observation sous-marine.",
        rating: 1,
        species: [],
        images: []
      },
      {
        name: "Plage de Bas-Du-Fort, Le Gosier",
        coords: [16.2138, -61.5240],      
        desc: "Tr√®s belle plage, tr√®s touristique et plut√¥t petite. L‚Äôeau y est prot√©g√©e, mais la visibilit√© reste faible et la biodiversit√© observ√©e limit√©e. Spot agr√©able pour se baigner, mais peu adapt√© au snorkeling.",
        rating: 1,
        species: [],
        images: []
      },
      {
        name: "Plage de Petit-Havre, Sainte-Anne",
        coords: [16.2090, -61.4270],      
        desc: "Petit coin sauvage appr√©ci√© pour les barbecues et un peu de surf. Quelques zones plus recul√©es offrent une visibilit√© correcte et quelques poissons, mais cela reste un petit spot de snorkeling sans grande richesse.",
        rating: 2,
        species: [],
        images: []
      },
      {
        name: "Anse Sainte-Marguerite, Le Moule",
        coords: [16.3893, -61.4049],      
        desc: "Zone partiellement prot√©g√©e des vagues, mais qui devient vite impraticable lorsque la houle est forte (ce qui est fr√©quent sur cette c√¥te). Plage assez rocheuse, pas tr√®s propre et peu adapt√©e au snorkeling. C‚Äôest surtout un tr√®s bel endroit pour se promener plut√¥t que pour observer les fonds marins.",
        rating: 1,
        species: [],
        images: []
      }
    ];

    /* ----------------------------------------------------------
       7. Marqueurs color√©s + popup avec photo
    ----------------------------------------------------------- */

    // Index courant de l'image pour chaque spot
    const currentImageIndex = spots.map(() => 0);

    // Fonction appel√©e par les boutons ‚Äπ et ‚Ä∫
    function changeImage(spotIndex, direction) {
      const imgs = spots[spotIndex].images;
      if (!imgs || imgs.length === 0) return;

      const n = imgs.length;
      // on avance ou recule dans le tableau, en bouclant
      currentImageIndex[spotIndex] =
        (currentImageIndex[spotIndex] + direction + n) % n;

      const imgEl = document.getElementById(`slider-img-${spotIndex}`);
      const counterEl = document.getElementById(`slider-counter-${spotIndex}`);

      if (imgEl) {
        imgEl.src = imgs[currentImageIndex[spotIndex]];
      }
      if (counterEl) {
        counterEl.textContent = `${currentImageIndex[spotIndex] + 1} / ${n}`;
      }
    }

    
    spots.forEach((spot, index) => {

      let imagesHtml = "";
        if (spot.images && spot.images.length > 0) {
        imagesHtml = `
          <div class="slider">
            <button type="button"
                    class="slider-btn"
                    onclick="changeImage(${index}, -1)">‚Äπ</button>
            <img id="slider-img-${index}"
                  src="${spot.images[0]}"
                  alt="${spot.name}"
                  style="max-width:180px; border-radius:8px; display:block;">
            <button type="button"
                    class="slider-btn"
                    onclick="changeImage(${index}, 1)">‚Ä∫</button>
          </div>
          <div class="slider-counter"
                id="slider-counter-${index}">
                1 / ${spot.images.length}
          </div>
        `;
      }

      const popupContent = `
        <b>${spot.name}</b><br>
        ${spot.desc}<br>
        Note : ${getStars(spot.rating)}<br><br>
        ${imagesHtml}
      `;

      const icon = L.divIcon({
        className: `custom-marker rating-${spot.rating}`,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });

      // üëâ on cr√©e le marker, avec un "title" = nom du spot (utilis√© par le plugin de recherche)
      const marker = L.marker(spot.coords, {
        icon,
        title: spot.name
      }).bindPopup(popupContent);

      // üëâ on garde les infos sur le marker pour les filtres plus tard
      marker.rating = spot.rating;  // note associ√©e au marker
      spot._marker = marker;        // on stocke le marker dans l'objet spot

      // üëâ on l‚Äôajoute au layer de markers (et donc √† la carte)
      markersLayer.addLayer(marker);
    });
    /* ----------------------------------------------------------
       8. L√©gende √©toiles + couleurs
    ----------------------------------------------------------- */
    const legend = L.control({ position: 'topright' });

    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      const ratings = [5, 4, 3, 2, 1];

      div.innerHTML += "<b>Qualit√© du spot</b><br>";

      ratings.forEach(r => {
        div.innerHTML += `
          <i style="background:${getColor(r)};"></i>
          ${getStars(r)}<br>
        `;
      });

      return div;
    };

    legend.addTo(map);

    // ----------------------------------------------------------
    // 9. Contr√¥le de recherche des spots
    // ----------------------------------------------------------
    const searchControl = new L.Control.Search({
      layer: markersLayer,              // on cherche dans ce layer
      propertyName: 'title',            // ce qu‚Äôon cherche = option "title" du marker
      marker: false,                    // ne pas ajouter un marker rouge par d√©faut
      initial: false,
      zoom: 14,
      textPlaceholder: 'Rechercher un spot...',
      collapsed: false                  // si tu veux qu‚Äôil soit ouvert par d√©faut
    });

    // Quand un spot est trouv√©, on ouvre sa popup
    searchControl.on('search:locationfound', function (e) {
      if (e.layer._popup) {
        e.layer.openPopup();
      }
    });

    map.addControl(searchControl);

    // --- Ouverture / fermeture du bloc filtres ---
    const filtersToggle = document.getElementById('filters-toggle');
    const filtersContent = document.getElementById('filters-content');
    const filtersArrow = document.querySelector('.filters-arrow');

    filtersToggle.addEventListener('click', () => {
      filtersContent.classList.toggle('hidden');
      filtersArrow.classList.toggle('open');
    });

    
    // ----------------------------------------------------------
    // 10. FILTRE PAR NOTE
    // ----------------------------------------------------------
    const checkboxes = document.querySelectorAll('#filters-box input[type="checkbox"]');

    checkboxes.forEach(cb => {
      cb.addEventListener('change', () => {

        // --- 1. Notes autoris√©es ---
        const allowedRatings = [...checkboxes]
          .filter(c => c.checked && c.dataset.rating)
          .map(c => Number(c.dataset.rating));

        // --- 2. Esp√®ces coch√©es ---
        const allowedSpecies = [...checkboxes]
          .filter(c => c.checked && c.dataset.species)
          .map(c => c.dataset.species);

        spots.forEach(spot => {
          const m = spot._marker;

          // --- Condition rating ---
          const ratingOK = allowedRatings.includes(spot.rating);

          // --- Condition esp√®ces ---
          let speciesOK = true;

          if (allowedSpecies.length > 0) {
            // le spot doit contenir toutes les esp√®ces coch√©es
            speciesOK = allowedSpecies.every(sp => spot.species.includes(sp));
          }

          // --- Affichage ou masquage ---
          if (ratingOK && speciesOK) {
            markersLayer.addLayer(m);
          } else {
            markersLayer.removeLayer(m);
          }
        });
      });
    });

  </script>
</body>
</html>
