<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Les Spots de Snorkeling en Guadeloupe</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    /* Taille de la carte */
    #map {
      height: 100vh;
      width: 100%;
    }

    /* --- L√©gende (agrandie + fond blanc) --- */
    .legend {
      background: white;
      padding: 15px;
      border-radius: 10px;
      font-size: 1.4em;
      line-height: 1.6em;
      box-shadow: 0 0 12px rgba(0,0,0,0.3);
    }

    .legend b {
      font-size: 1.2em;
    }

    .legend i {
      width: 20px !important;
      height: 20px !important;
      border-radius: 50%;
      margin-right: 10px;
      display: inline-block;
    }

    /* --- Marqueurs personnalis√©s color√©s --- */
    .custom-marker {
      border-radius: 50%;
      border: 2px solid #ffffff;
      box-shadow: 0 0 8px rgba(0,0,0,0.4);
    }

    .rating-5 { background: #1a9850; }
    .rating-4 { background: #66bd63; }
    .rating-3 { background: #c8ffb5; }
    .rating-2 { background: #fee08b; }
    .rating-1 { background: #d73027; }

    .slider {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: 5px;
    }

    .slider-btn {
      border: none;
      background: rgba(0,0,0,0.6);
      color: white;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .slider-btn:hover {
      background: rgba(0,0,0,0.8);
    }

    .slider-counter {
      text-align: center;
      font-size: 0.9em;
      margin-top: 2px;
      color: #333;
    }

    .slider-img-wrapper {
      width: 180px;        /* largeur fixe de la zone image */
      height: 130px;       /* hauteur fixe => le texte ne bouge plus */
      overflow: hidden;    /* on coupe ce qui d√©passe */
      border-radius: 8px;
      display: flex;
      align-items: center; /* centre l‚Äôimage verticalement */
      justify-content: center; /* centre horizontalement */
    }

    .slider-img-wrapper img {
      max-width: 100%;
      max-height: 100%;
      display: block;
    }

    #filters-box {
      position: absolute;
      left: 20px;
      top: 145px;              /* ‚âà sous la barre de recherche */
      right: auto;
      bottom: auto;
      transform: none;
      background: white;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0,0,0,0.3);
      font-size: 1.1em;
      z-index: 999;           /* au-dessus de la carte et des tuiles */
    }

    /* Bouton d‚Äôen-t√™te (ligne "Filtres ‚ñæ") */
    .filters-header {
      width: 100%;
      background: transparent;
      border: none;
      padding: 0;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
    }

    /* Fl√®che anim√©e */
    .filters-arrow {
      display: inline-block;
      transition: transform 0.2s ease;
    }

    .filters-arrow.open {
      transform: rotate(180deg); /* fl√®che vers le haut */
    }

    /* Contenu (les cases √† cocher) */
    #filters-content {
      margin-top: 8px;
    }

    #filters-content.hidden {
      display: none;
    }

    #filters-content label {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;
      font-size: 0.95em;
    }

    #filters-content input {
      margin: 0;
    }

    #filters-box h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 1.1em;
    }
    #filters-box label {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .lightbox {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .lightbox.hidden {
      display: none;
    }

    .lightbox-inner {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #lightbox-img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.6);
    }

    .lightbox-close {
      position: absolute;
      top: -40px;
      right: 0;
      border: none;
      background: transparent;
      color: white;
      font-size: 26px;
      cursor: pointer;
    }

    .lightbox-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 32px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lightbox-arrow.left {
      left: -50px;
    }

    .lightbox-arrow.right {
      right: -50px;
    }

    /* Quand une popup est ouverte, on masque les UI par-dessus */
    body.popup-open #filters-box,
    body.popup-open .legend,
    body.popup-open .leaflet-control-layers,
    body.popup-open .leaflet-control-zoom,
    body.popup-open .leaflet-control-search {
      opacity: 0;
      pointer-events: none;
    }

    /* Quand la modale de langue est ouverte, on floute la carte */
    body.lang-modal-open #map {
      filter: blur(6px);
      pointer-events: none;
    }
    
    /* Overlay plein √©cran pour centrer le carr√© blanc */
    #language-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4); /* l√©ger voile noir pour l‚Äôarri√®re-plan */
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20000;
    }

    /* Cach√©e quand on a choisi la langue */
    #language-modal.hidden {
      display: none;
    }

    /* Le carr√© blanc au centre */
    .language-modal-content {
      background: white;
      padding: 24px 30px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      max-width: 90vw;
      text-align: center;
      font-family: system-ui, sans-serif;
    }

    .language-modal-content h2 {
      margin-top: 0;
      margin-bottom: 12px;
    }

    .language-buttons {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 10px;
    }

    .language-buttons button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .language-buttons button:hover {
      transform: translateY(-1px);
    }

    .language-buttons .btn-fr {
      background: #1a9850;
      color: white;
    }

    .language-buttons .btn-en {
      background: #0077b6;
      color: white;
    }

    .lang-button {
      width: 100%;
      padding: 8px 10px;
      background: #f0f0f0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 8px;
      font-size: 1em;
    }

    .lang-button:hover {
      background: #e0e0e0;
    }

    /* Titre overlay dans la lightbox */
    .lightbox-title {
      position: absolute;
      bottom: 22px;
      left: 50%;
      transform: translateX(-50%);
      color: #fff;
      font-family: 'Dancing Script', cursive;
      font-size: 2rem;
      font-weight: 600;
      text-shadow: 0 0 12px rgba(0,0,0,0.75);
      pointer-events: none;
    }

    /* --- Instagram button bottom-right --- */
    #insta-button {
      position: absolute;
      right: 20px;
      bottom: 20px;
      z-index: 9999;
    }

    #insta-button img {
      width: 100px;           /* adjust size as you like */
      height: 100px;
      border-radius: 25px;    /* makes it round if the image is square */
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
      cursor: pointer;
      object-fit: cover;
    }

    .popup-comments {
      margin-top: 10px;
      max-height: 260px;
      overflow-y: auto;
      border-top: 1px solid rgba(0,0,0,0.1);
      padding-top: 6px;
    }

    .popup-comments .comments-hint {
      font-size: 0.85em;
      margin-bottom: 4px;
      color: #555;
    }

    .popup-comments {
      margin-top: 10px;
    }

    /* La petite barre cliquable "Ajouter un commentaire" */
    .comments-toggle {
      width: 100%;
      border: none;
      background: #f0f0f0;
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 0.9em;
      text-align: left;
      cursor: pointer;
    }

    .comments-toggle:hover {
      background: #e0e0e0;
    }

    /* Le bloc qui contient r√©ellement Disqus */
    .comments-panel {
      margin-top: 6px;
      max-height: 260px;
      overflow-y: auto;
      border-top: 1px solid rgba(0,0,0,0.1);
      padding-top: 6px;
    }

    .comments-panel.hidden {
      display: none;
    }

    .popup-comments .comments-hint {
      font-size: 0.85em;
      margin-bottom: 4px;
      color: #555;
    }

    @media (max-width: 768px) {
      .leaflet-popup-content {
        font-size: 0.95em !important;   /* texte plus petit */
        line-height: 1.3em;
      }
    
      .leaflet-popup-content-wrapper {
        padding: 8px 10px !important;   /* moins de marges internes */
      }
      /* 1. Cacher le zoom sur mobile */
      .leaflet-control-zoom {
        display: none !important;
      }

      .comments-panel {
        max-height: 200px;
      }

      .popup-comments {
        max-height: 200px;
      }

      #insta-button img {
        width: 60px;
        lenght: 60px;
        object-fit: cover;
      }

      /* 2. R√©duire les marges et resserrer les contr√¥les en haut √† gauche */
      .leaflet-top.leaflet-left .leaflet-control {
        margin-top: 6px;      /* espace vertical minimal entre les contr√¥les */
        margin-left: 6px;
      }
      
      /* Lightbox plus adapt√©e au t√©l√©phone */
      .lightbox-inner {
        max-width: 90vw;
        max-height: 70vh;
        padding: 0 10px;
      }

      #lightbox-img {
        max-width: 100%;
        max-height: 80vh;
      }

      .lightbox-arrow.left {
        left: 10px;
      }

      .lightbox-arrow.right {
        right: 10px;
      }

      .lightbox-close {
        top: 10px;
        right: 10px;
      }

      /* Slider images plus grand sur mobile */
      .slider-img-wrapper {
        width: 70vw;
        height: 40vw;
      }

      .slider-btn {
        width: 32px;
        height: 32px;
        font-size: 18px;
      }

      /* Filtres en bas au centre */
      #filters-box {
        left: 50%;
        right: auto;
        top: auto;
        bottom: 20px;
        transform: translateX(-50%);
        font-size: 1em;
        padding: 8px 10px;
      }

      /* L√©gende r√©duite */
      .legend {
        font-size: 1em !important;     /* ‚Üì taille texte */
        padding: 10px !important;      /* ‚Üì marges internes */
      }

      .legend i {
        width: 14px !important;        /* ‚Üì taille des cercles */
        height: 14px !important;
        margin-right: 6px !important;
      }

      /* R√©duction du menu des fonds de carte */
      .leaflet-control-layers {
        font-size: 0.8em !important;     /* taille du texte */
        padding: 4px !important;         /* marge interne */
      }

      .leaflet-control-layers label {
        font-size: 0.9em !important;
      }

      .leaflet-control-layers-expanded {
        padding: 6px !important;
      }

      .lightbox-title {
        font-size: 1.3rem;      /* plus petit sur mobile */
        bottom: 12px;           /* optionnel : remonter un peu le texte */
      }
    }

    /* Contr√¥le des fonds de carte int√©gr√© dans le menu */
    #menu-baselayers .leaflet-control,
    #menu-baselayers .leaflet-control-layers {
      float: none;        /* pas de flottant */
      clear: both;
      display: block;
      margin: 0;          /* pas de marge autour de la bo√Æte Leaflet */
    }

    /* On enl√®ve la bo√Æte ind√©pendante et l‚Äôombre port√©e */
    #menu-baselayers .leaflet-control-layers {
      background: transparent;
      box-shadow: none;
      border-radius: 0;
      padding: 0;
    }

    /* Optionnel : un peu d‚Äôair autour du contenu du contr√¥le */
    #menu-baselayers .leaflet-control-layers-list {
      margin-top: 4px;
    }
    
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-search@4.0.0/dist/leaflet-search.min.css">
  <link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@500;600&display=swap">

</head>
  
<body>

  <div id="filters-box">
    <button id="filters-toggle" class="filters-header">
      <span>Menu</span>
      <span class="filters-arrow">‚ñæ</span>
    </button>

    <div id="filters-content" class="hidden">
      <!-- 1. Fonds de carte -->
      <div id="menu-baselayers"></div>
      <hr style="margin:8px 0;">

      <!-- 3. Filtres par note -->
      <label><input type="checkbox" data-rating="5" checked> 5 ‚òÖ Excellent</label>
      <label><input type="checkbox" data-rating="4" checked> 4 ‚òÖ Tr√®s bien</label>
      <label><input type="checkbox" data-rating="3" checked> 3 ‚òÖ Bien</label>
      <label><input type="checkbox" data-rating="2" checked> 2 ‚òÖ Neutre</label>
      <label><input type="checkbox" data-rating="1" checked> 1 ‚òÖ Mauvais</label>

      <hr style="margin:8px 0;">

      <!-- 3b. Filtres esp√®ces -->
      <label><input type="checkbox" data-species="tortue"> Tortues üê¢</label>
      <label><input type="checkbox" data-species="requin"> Requins ü¶à</label>

      <hr>

      <!-- 4. Changer de langue -->
      <button onclick="openLanguageModal()" class="lang-button">üåê Changer de langue</button>
</div>


  </div>
  <div id="map"></div>

  <div id="lightbox" class="lightbox hidden">
    <div class="lightbox-inner">
      <button class="lightbox-close" onclick="closeLightbox()">‚úï</button>

      <button class="lightbox-arrow left" onclick="changeLightboxImage(-1)">‚Äπ</button>

      <img id="lightbox-img" src="" alt="Photo spot">

      <!-- üî• Titre overlay -->
      <div class="lightbox-title">Underwater Insights</div>

      <button class="lightbox-arrow right" onclick="changeLightboxImage(1)">‚Ä∫</button>
    </div>
  </div>


  <!-- MODALE DE LANGUE -->
  <div id="language-modal">
    <div class="language-modal-content">
      <h2>Choose your language</h2>
      <p>You can change the language later in the "Menu".</p>
      <div class="language-buttons">
        <button class="btn-fr" onclick="selectLanguage('fr')">Fran√ßais</button>
        <button class="btn-en" onclick="selectLanguage('en')">English</button>
      </div>
    </div>
  </div>

  <!-- üîó Instagram button -->
  <div id="insta-button">
    <a href="https://www.instagram.com/underwater_insights/"
       target="_blank"
       rel="noopener noreferrer">
      <img src="images/insta.png" alt="Instagram Underwater Insights">
    </a>
  </div>

  <!-- Parking invisible pour le module Disqus -->
  <div id="disqus-parking" style="display:none;">
    <div id="disqus_thread"></div>
  </div>

  <script>
    // ‚ö†Ô∏è Remplace ici par TON shortname Disqus
    const DISQUS_SHORTNAME = 'underwater-insights';

    let disqusLoaded = false;

    function loadDisqusForSpot(spotId) {
      // premi√®re fois : on charge le script
      if (!disqusLoaded) {
        disqusLoaded = true;

        window.disqus_config = function () {
          this.page.url = window.location.href + '#' + spotId;
          this.page.identifier = spotId;
        };

        const d = document, s = d.createElement('script');
        s.src = 'https://' + DISQUS_SHORTNAME + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      } else {
        // ensuite : on change juste de fil de discussion
        DISQUS.reset({
          reload: true,
          config: function () {
            this.page.url = window.location.href + '#' + spotId;
            this.page.identifier = spotId;
          }
        });
      }
    }
  </script>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-search@4.0.0/dist/leaflet-search.min.js"></script>

  <script>

    // === Choix de langue & textes FR/EN ===
    let currentLang = 'en';

    const i18n = {
      fr: {
        legendTitle: "Qualit√© du spot",
        filtersTitle: "Menu",
        ratingTexts: {
          5: "5 ‚òÖ Excellent",
          4: "4 ‚òÖ Tr√®s bien",
          3: "3 ‚òÖ Bien",
          2: "2 ‚òÖ Neutre",
          1: "1 ‚òÖ Mauvais"
        },
        species: {
          tortue: "Tortues üê¢",
          requin: "Requins ü¶à"
        },
        searchPlaceholder: "Rechercher un spot...",
        mapLayers: {
          satellite: "Vue Satellite",
          osm: "Carte classique (OSM)",
          relief: "Relief / Topographie"
        },
        changeLanguage: "Changer de langue",
        commentsTitle: "üí¨ Commentaires sur ce spot :",
        commentsToggleClosed: "üí¨ Ajouter un commentaire",
        commentsToggleOpen: "‚úï Masquer les commentaires"
      },
      en: {
        legendTitle: "Spot quality",
        filtersTitle: "Menu",
        ratingTexts: {
          5: "5 ‚òÖ Excellent",
          4: "4 ‚òÖ Very good",
          3: "3 ‚òÖ Good",
          2: "2 ‚òÖ Average",
          1: "1 ‚òÖ Poor"
        },
        species: {
          tortue: "Turtles üê¢",
          requin: "Sharks ü¶à"
        },
        searchPlaceholder: "Search a spot...",
        mapLayers: {
          satellite: "Satellite View",
          osm: "Classic map (OSM)",
          relief: "Relief / Topographic"
        },
        changeLanguage: "Change language",
        commentsTitle: "üí¨ Comments on this spot:",
        commentsToggleClosed: "üí¨ Add a comment",
        commentsToggleOpen: "‚úï Hide comments"
      }
    };

    // Ces variables serviront √† manipuler la l√©gende et la barre de recherche
    let legendControl;
    let searchControl;

    // √Ä l'ouverture de la page, on affiche la modale et on floute la carte
    document.body.classList.add('lang-modal-open');

    // Si tu veux m√©moriser le choix dans le navigateur :
    const savedLang = localStorage.getItem('snorkelLang');
    if (savedLang) {
      currentLang = savedLang;
      // On cache la modale et on enl√®ve le flou tout de suite
      document.getElementById('language-modal').classList.add('hidden');
      document.body.classList.remove('lang-modal-open');
    }

    // Fonction appel√©e quand on clique sur Fran√ßais / English
    function selectLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('snorkelLang', lang);

      document.getElementById('language-modal').classList.add('hidden');
      document.body.classList.remove('lang-modal-open');

      // On applique la langue √† toute l‚Äôinterface
      applyLanguage();
    }

    // Fonction pour rouvrir la modale de langue
    function openLanguageModal() {
      const modal = document.getElementById('language-modal');
      modal.classList.remove('hidden');
      document.body.classList.add('lang-modal-open');
    }

    /* ----------------------------------------------------------
       1. D√©finir les limites autour de la Guadeloupe
    ----------------------------------------------------------- */
    const guadeloupeBounds = L.latLngBounds(
      [15.7, -62.1],   // sud-ouest
      [16.6, -60.9]    // nord-est
    );

    /* ----------------------------------------------------------
       2. Cr√©ation de la carte + blocages de d√©placement
    ----------------------------------------------------------- */
    const map = L.map('map', {
      center: [16.265, -61.551],
      zoom: 10,
      maxBounds: guadeloupeBounds,
      maxBoundsViscosity: 1.0
    });

    // üëâ Nouveau : layer qui contiendra tous les markers
    const markersLayer = L.layerGroup().addTo(map);


    /* ----------------------------------------------------------
       3. Tuiles (fonds de carte)
    ----------------------------------------------------------- */
    const satellite = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: 'Tiles ¬© Esri ‚Äî Source: Esri, USDA, USGS, GeoEye, etc.' }
    );
    
    const osm = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution: '¬© OpenStreetMap contributors' }
    );

    const relief = L.tileLayer(
      'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
      { attribution: '¬© OpenTopoMap (CC-BY-SA)' }
    );

    // Couche par d√©faut
    satellite.addTo(map);

    /* ----------------------------------------------------------
       4. Contr√¥le permettant de changer de fond de carte
    ----------------------------------------------------------- */
    let baseLayers = {};

    let layersControl = null;

    /* ----------------------------------------------------------
       5. Fonctions utilitaires pour couleurs + √©toiles
    ----------------------------------------------------------- */
    function getColor(rating) {
      switch (rating) {
        case 5: return "#1a9850";
        case 4: return "#66bd63";
        case 3: return "#c8ffb5";
        case 2: return "#fee08b";
        case 1: return "#d73027";
        default: return "#888";
      }
    }

    function getStars(rating) {
      return "‚òÖ".repeat(rating) + "‚òÜ".repeat(5 - rating);
    }

    /* ----------------------------------------------------------
       6. Spots (√† adapter avec tes vrais lieux + photos)
    ----------------------------------------------------------- */
    const spots = [
      {
        name: {
          fr: "Malendure plage, Bouillante",
          en: "Malendure beach, Bouillante"
        },
        desc: {
          fr: "Un lieu incontournable pour observer des tortues marines. Pour maximiser vos chances, rejoignez la petite plage situ√©e au nord de la plage principale de Malendure : c‚Äôest l√† que les rencontres sont les plus fr√©quentes. On y croise aussi r√©guli√®rement des poissons-torpilles et quelques barracudas. La visibilit√© y est g√©n√©ralement tr√®s bonne, ce qui en fait un spot parfait pour une exploration tranquille.",
          en: "A must-see spot to observe sea turtles. To maximize your chances, head to the small beach located north of the main Malendure beach: this is where encounters are most frequent. Torpedo rays and a few barracudas are also commonly seen. Visibility is generally excellent, making it the perfect place for a peaceful exploration."
        },
        coords: [16.1726, -61.7791],
        rating: 4,
        species: ["tortue"],
        images: [
          "images/malendure1.JPG","images/malendure2.JPG","images/malendure3.JPG",
          "images/malendure4.jpg","images/malendure5.jpg","images/malendure6.jpg",
          "images/malendure7.jpg","images/malendure8.jpg"
        ]
      },
      {
        name: {
          fr: "Bosco, Deshaies",
          en: "Bosco, Deshaies"
        },
        desc: {
          fr: "Spot discret et paisible ‚Äì Notre coup de c≈ìur : Un lieu calme, presque secret, auquel on acc√®de en contournant un portail signal√© comme priv√© (l‚Äôacc√®s est parfaitement l√©gal). C‚Äôest l‚Äôun de nos spots pr√©f√©r√©s : la plage est bord√©e d‚Äôune grande richesse aquatique, avec une excellente visibilit√© et, parfois, la chance de croiser des tortues vertes ou imbriqu√©es. De nombreux crabes touloulous pourrons vous guidez jusqu‚Äôa la mer. La plage dispose d‚Äôun petit carbet id√©al pour installer un hamac et se d√©tendre entre deux sessions de snorkeling. On y trouve aussi quantit√© de coquillages, parfaits pour les curieux. Une ambiance tranquille et authentique, √† ne pas manquer.",
          en: "A discreet and peaceful spot ‚Äì Our favorite: A quiet, almost secret location, accessible by walking around a gate marked as private (the access is fully legal). It is one of our preferred spots: the shoreline is rich in marine life with excellent visibility, and sometimes you may spot green or hawksbill turtles. Numerous touloulou crabs may guide you toward the sea. The beach has a small shelter perfect for hanging a hammock and relaxing between snorkeling sessions. You‚Äôll also find many shells, ideal for curious explorers. A calm, authentic atmosphere not to be missed."
        },
        coords: [16.2864, -61.8027],
        rating: 5,
        species: ["tortue"],
        images: [
          "images/bosco1.jpg","images/bosco2.jpg","images/bosco3.jpg",
          "images/bosco4.jpg","images/bosco5.jpg","images/bosco6.jpg",
          "images/bosco7.jpg","images/bosco8.jpg","images/bosco9.jpg"
        ]
      },
      {
        name: {
          fr: "Anse de Deshaies, Deshaies",
          en: "Deshaies cove, Deshaies"
        },
        desc: {
          fr: "M√™me si la zone accueille de nombreux bateaux et que l‚Äôeau peut parfois √™tre un peu turbide, le spot r√©serve de belles rencontres : poissons-globes, tortues et une faune vari√©e √©voluent dans ce secteur prot√©g√© des vagues. L‚Äôambiance reste globalement calme et c‚Äôest un endroit plaisant pour une sortie snorkeling sans trop de courant. Petit bonus : l‚Äôexcellent restaurant L‚ÄôAmer se trouve juste √† c√¥t√©, parfait pour prolonger la journ√©e (l‚ÄôAssiette cr√©ole est un d√©lice).",
          en: "Even though the area hosts many boats and the water can sometimes be a bit murky, the spot still offers lovely encounters: pufferfish, turtles, and a variety of marine life thrive in this wave-protected zone. The atmosphere is generally calm, making it a pleasant place for a snorkeling trip without strong currents. Bonus: the excellent restaurant L‚ÄôAmer is right nearby, perfect for extending your day (the Creole platter is delicious)."
        },
        coords: [16.3075, -61.7966],
        rating: 2,
        species: ["tortue"],
        images: []
      },
      {
        name: {
          fr: "Ravine Thomas, Bouillante",
          en: "Ravine Thomas, Bouillante"
        },
        desc: {
          fr: "Un spot magnifique o√π la vie foisonne : nudibranches, serpentines, poulpes, coquillages‚Ä¶ Les roches nombreuses cr√©ent une multitude de petits abris qui attirent une grande diversit√© d‚Äôesp√®ces et offrent un d√©cor riche en couleurs tout au long de l‚Äôexploration. La zone abrite une biodiversit√© de r√™ve pour les amateurs de macro et d‚Äôobservations d√©taill√©es. En bonus, le site se trouve √† proximit√© de bassins d‚Äôeaux thermales, parfaits pour une pause d√©tente apr√®s la sortie.",
          en: "A stunning spot teeming with life: nudibranchs, snake eels, octopuses, seashells‚Ä¶ The many rocks create countless tiny shelters that attract a great variety of species and provide a colorful scenery throughout the exploration. The area offers dreamlike biodiversity for macro lovers and detailed observation. As a bonus, the site is close to natural hot spring pools‚Äîperfect for relaxing after your session."
        },
        coords: [16.1095, -61.7747],
        rating: 5,
        species: ["tortue"],
        images: [
          "images/ravine_thomas1.jpg","images/ravine_thomas2.jpg","images/ravine_thomas3.jpg",
          "images/ravine_thomas4.jpg","images/ravine_thomas5.jpg","images/ravine_thomas6.JPG",
          "images/ravine_thomas7.jpg","images/ravine_thomas8.jpg","images/ravine_thomas9.jpg",
          "images/ravine_thomas10.jpg"
        ]
      },
      {
        name: {
          fr: "Anse √† la Barque, Bouillante",
          en: "Anse √† la Barque, Bouillante"
        },
        desc: {
          fr: "Un lieu bien prot√©g√© des vagues, g√©n√©ralement tr√®s calme et peu fr√©quent√© par les bateaux. La zone abrite une belle diversit√© d‚Äôesp√®ces, avec notamment plusieurs pieuvres, et de nombreux juv√©niles qui trouvent refuge dans les roches. Le fond est constitu√© de structures rocheuses am√©nag√©es par l‚Äôhumain, cr√©ant une multitude de petits abris pour la faune. En longeant l‚Äôanse, on passe d‚Äôune petite mangrove √† de hautes falaises, offrant un d√©cor vari√© et agr√©able √† explorer.",
          en: "A spot well-sheltered from waves, generally very calm and rarely visited by boats. The area hosts a nice diversity of species, including several octopuses and many juveniles that take refuge in the rocks. The seabed is made of human-built rocky structures, creating many small shelters for marine life. Following the cove, you move from a small mangrove to tall cliffs, offering varied and pleasant scenery to explore."
        },
        coords: [16.0893, -61.7688],
        rating: 3,
        species: ["tortue"],
        images: [
          "images/anse_a_la_barque1.JPG","images/anse_a_la_barque2.jpg","images/anse_a_la_barque3.jpg",
          "images/anse_a_la_barque4.jpg","images/anse_a_la_barque5.jpg","images/anse_a_la_barque6.jpg"
        ]
      },
      {
        name: {
          fr: "Petite Terre, Terre-de-Bas",
          en: "Petite Terre, Terre-de-Bas"
        },
        desc: {
          fr: "Un incontournable absolu. V√©ritable nurserie de requins-citrons et de tortues, Petite Terre est l‚Äôun des plus beaux sites de snorkeling de Guadeloupe. On y observe r√©guli√®rement des requins-citrons juv√©niles, des raies pastenagues, et parfois, avec un peu de chance, des requins dormeurs ou des raies aigles. Les barracudas sont aussi fr√©quents dans les zones calmes. Il s‚Äôagit d‚Äôune r√©serve naturelle, avec de nombreuses r√®gles √† respecter pour prot√©ger l‚Äô√©cosyst√®me. √Ä terre, la pr√©sence d‚Äôiguanes end√©miques. Sous l‚Äôeau, de nombreux coraux sont malheureusement ab√Æm√©s dans les zones tr√®s fr√©quent√©es. La zone ouverte au public se situe uniquement entre les deux √Æles ; le reste de la r√©serve est strictement interdit d‚Äôacc√®s afin de pr√©server la faune. Un site exceptionnel, √† visiter au moins une fois.",
          en: "An absolute must-see. A true nursery for lemon sharks and turtles, Petite Terre is one of Guadeloupe‚Äôs most beautiful snorkeling sites. Juvenile lemon sharks and stingrays are commonly spotted, and sometimes‚Äîif you're lucky‚Äînurse sharks or eagle rays. Barracudas are also frequent in calm areas. It is a protected natural reserve with many rules to preserve the ecosystem. On land, you will see endemic iguanas. Underwater, many corals are unfortunately damaged in highly visited zones. The public area is limited to the space between the two islands; the rest of the reserve is strictly off-limits to protect wildlife. An exceptional site to visit at least once."
        },
        coords: [16.1747, -61.1092],
        rating: 5,
        species: ["tortue", "requin"],
        images: [
          "images/petite_terre1.jpg","images/petite_terre2.jpg","images/petite_terre3.jpg",
          "images/petite_terre4.jpg","images/petite_terre5.jpg","images/petite_terre6.jpg",
          "images/petite_terre7.jpg","images/petite_terre8.jpg","images/petite_terre9.jpg"
        ]
      },
      {
        name: {
          fr: "Trou Man Louis, Port-Louis",
          en: "Trou Man Louis, Port-Louis"
        },
        desc: {
          fr: "Un lieu splendide, avec une eau chaude, limpide et remplie de poissons color√©s. Cependant, la prudence est de mise : lorsque la houle se l√®ve, le snorkeling peut devenir difficile et l‚Äôeau plus agit√©e. Par mer calme, c‚Äôest un v√©ritable petit paradis pour une exploration sereine.",
          en: "A gorgeous spot with warm, clear water filled with colorful fish. However, caution is needed: when the swell rises, snorkeling can become difficult and the water more turbulent. In calm seas, it becomes a true little paradise for peaceful exploration."
        },
        coords: [16.4861, -61.4972],
        rating: 4,
        species: [],
        images: ["images/trou_man_louis1.JPG","images/trou_man_louis2.jpg"]
      },
      {
        name: {
          fr: "√élets du Gosier, Le Gosier",
          en: "Gosier islets, Le Gosier"
        },
        desc: {
          fr: "La zone pr√©sente un fort impact anthropique, et l‚Äô√©tat du site sous-marin est malheureusement tr√®s alt√©r√©. La balade autour de l‚Äô√Ælet reste agr√©able, mais ce n‚Äôest pas un endroit recommand√© pour le snorkeling, la biodiversit√© y √©tant tr√®s pauvre.",
          en: "The area shows strong human impact, and the underwater environment is unfortunately very degraded. Walking around the islet is pleasant, but it is not a recommended snorkeling site due to its very low biodiversity."
        },
        coords: [16.2000, -61.4921],
        rating: 1,
        species: [],
        images: []
      },
      {
        name: {
          fr: "Malendure, Bouillante ‚Äì dortoir des tortues",
          en: "Malendure, Bouillante ‚Äì turtle sleeping ground"
        },
        desc: {
          fr: "Juste au pied du club de plong√©e Les Heures Saines se trouve le v√©ritable dortoir des tortues vertes et imbriqu√©es locales. Le spot est particuli√®rement impressionnant de nuit, lorsque les tortues viennent se reposer entre les blocs rocheux. La zone offre √©galement une grande richesse de coraux et d‚Äôesp√®ces qui se cachent dans les formations rocheuses. Un lieu √† forte valeur naturelle, id√©al pour une sortie calme et immersive.",
          en: "Right below the dive club Les Heures Saines lies the true sleeping ground of the local green and hawksbill turtles. The spot is especially impressive at night, when turtles come to rest among the rocky formations. The area is also rich in corals and species hiding in the rocks. A place of high natural value, ideal for a calm and immersive night snorkeling session."
        },
        coords: [16.1691, -61.7776],
        rating: 5,
        species: ["tortue"],
        images: [
          "images/malendure_night1.jpg","images/malendure_night2.jpg","images/malendure_night3.jpg",
          "images/malendure_night4.jpg","images/malendure_night5.jpg","images/malendure_night6.JPG",
          "images/malendure_night7.jpg","images/malendure_night8.jpg","images/malendure_night9.jpg",
          "images/malendure_night10.jpg","images/malendure_night11.jpg","images/malendure_night12.jpg",
          "images/malendure_night13.jpg"
        ]
      },
      {
        name: {
          fr: "√élets Pigeon (R√©serve Cousteau), Bouillante",
          en: "Cousteau Reserve (Pigeon Islets), Bouillante"
        },
        desc: {
          fr: "Un spot accessible en kayak, avec une eau transparente et une vaste zone √† explorer. On y rencontre de nombreux poissons balistes non agressifs, ainsi qu‚Äôune faune vari√©e dispers√©e sur une grande superficie. Le site poss√®de encore un fort potentiel d‚Äôexploration, id√©al pour ceux qui aiment s‚Äôaventurer un peu plus loin.",
          en: "A spot accessible by kayak, with clear waters and a vast area to explore. Many non-aggressive triggerfish can be seen, along with a diverse marine fauna spread across a large zone. The site still holds great exploration potential, ideal for those who enjoy venturing further."
        },
        coords: [16.1674, -61.7895],
        rating: 5,
        species: ["tortue"],
        images: [
          "images/reserve_cousteau1.jpg","images/reserve_cousteau2.JPG","images/reserve_cousteau3.jpg"
        ]
      },
      {
        name: {
          fr: "Plage de Leroux, Deshaies",
          en: "Leroux beach, Deshaies"
        },
        desc: {
          fr: "L‚Äôun des meilleurs endroits pour profiter d‚Äôun excellent √©quilibre entre calme, beaut√© et qualit√© de snorkeling. L‚Äô√©pi central concentre une biodiversit√© remarquable, m√™me si la zone reste relativement petite. Le reste du site est un peu plus d√©grad√©, mais l‚Äôensemble demeure tr√®s agr√©able : passer une apr√®s-midi sur cette plage est vivement recommand√©",
          en: "One of the best places to enjoy a perfect balance of calmness, beauty, and snorkeling quality. The central jetty concentrates remarkable biodiversity, even though the area is relatively small. The rest of the site is slightly more degraded, but the whole place remains very pleasant‚Äîspending an afternoon here is highly recommended."
        },
        coords: [16.2769, -61.8050],
        rating: 3,
        species: ["tortue"],
        images: [
          "images/plage_leroux1.jppg.JPG","images/plage_leroux2.jpg","images/plage_leroux3.jpg",
          "images/plage_leroux4.jpg","images/plage_leroux5.jpg","images/plage_leroux6.jpg",
          "images/plage_leroux7.JPG"
        ]
      },
      {
        name: {
          fr: "Plage du Souffleur, Port-Louis",
          en: "Souffleur beach, Port-Louis"
        },
        desc: {
          fr: "Le fond marin est assez d√©grad√©, avec des r√©sidus de filets de p√™che et quelques plastiques dispers√©s sur le sable. L‚Äôeau reste belle et l‚Äôon peut croiser quelques poissons, mais le snorkeling est moins int√©ressant que sur d‚Äôautres sites de l‚Äô√Æle. La plage, en revanche, est tr√®s fr√©quent√©e et particuli√®rement jolie, id√©ale pour profiter d‚Äôun moment au soleil en famille ou entre amis, m√™me si l‚Äôexploration sous-marine est limit√©e.",
          en: "The seabed is quite degraded, with remnants of fishing nets and some plastic scattered on the sand. The water remains beautiful and you can encounter some fish, but snorkeling is less interesting than in other areas of the island. The beach itself, however, is popular and very pretty‚Äîideal for enjoying the sun with family or friends, even if underwater exploration is limited."
        },
        coords: [16.4258, -61.5353],
        rating: 2,
        species: [],
        images: ["images/plage_du_souffleur1.jpg","images/plage_du_souffleur2.jpg"]
      },
      {
        name: {
          fr: "Plage d‚ÄôAntigues, Port-Louis",
          en: "Antigues beach, Port-Louis"
        },
        desc: {
          fr: "Une plage similaire √† la tr√®s connue plage du Souffleur, mais plus √©loign√©e du centre, donc nettement plus calme et moins fr√©quent√©e. Les herbiers marins y sont plus pr√©sents, offrant de belles occasions d‚Äôobserver des raies et parfois m√™me des requins-citrons juv√©niles. Un spot agr√©able pour ceux qui veulent profiter de la nature sans la foule.",
          en: "A beach similar to the popular Souffleur Beach, but farther from the center, making it much calmer and less crowded. Seagrass beds are more present, offering great opportunities to observe rays and sometimes even juvenile lemon sharks. A pleasant spot for those who want to enjoy nature without the crowds."
        },
        coords: [16.4369, -61.5386],
        rating: 3,
        species: ["requin"],
        images: [
          "images/plage_antigues1.jpg","images/plage_antigues2.jpg",
          "images/plage_antigues3.jpg","images/plage_antigues4.jpg"
        ]
      },
      {
        name: {
          fr: "Anse des Rochers, Saint-Fran√ßois",
          en: "Anse des Rochers, Saint-Fran√ßois"
        },
        desc: {
          fr: "Plage s√©curis√©e et id√©ale pour les d√©butants Un site accessible via une r√©sidence / centre de vacances, avec une tr√®s belle plage prot√©g√©e des vagues et parfaitement adapt√©e au snorkeling calme. La zone abrite surtout des esp√®ces juv√©niles, qui trouvent refuge dans les herbiers et les petits amas de roches dispers√©s pr√®s du rivage. Un spot agr√©able pour une sortie tranquille et s√©curis√©e.",
          en: "A safe beach ideal for beginners. A site accessible through a residence or holiday complex, featuring a beautiful wave-protected beach perfectly suited for calm snorkeling. The zone hosts mostly juvenile species that take refuge in seagrass beds and small rock clusters near the shore. A pleasant spot for a quiet and safe outing."
        },
        coords: [16.2417, -61.3064],
        rating: 2,
        species: [],
        images: []
      },
      {
        name: {
          fr: "Les Trois Pointes, Vieux-Fort",
          en: "Three Points, Vieux-Fort"
        },
        desc: {
          fr: "Un lieu riche en couleurs et en biodiversit√©, o√π les nuances de bleu sont absolument magnifiques et o√π de nombreuses esp√®ces √©voluent autour de vous. Il peut y avoir un peu de mouvement d‚Äôeau, donc prudence, mais l‚Äôendroit reste un spot recul√©, paisible et parfait pour une exploration en immersion totale.",
          en: "A place rich in color and biodiversity, with stunning shades of blue and many species surrounding you. There can be some water movement, so caution is advised, but it remains a secluded, peaceful spot perfect for full-immersion exploration."
        },
        coords: [15.9556, -61.7105],
        rating: 4,
        species: ["tortue"],
        images: [
          "images/les_trois_pointes1.JPG","images/les_trois_pointes2.jpg","images/les_trois_pointes3.jpg"
        ]
      },
      {
        name: {
          fr: "Morphy, Pointe-Noire",
          en: "Morphy, Pointe-Noire"
        },
        desc: {
          fr: "Un lieu l√©g√®rement expos√© √† la houle de la mer des Cara√Øbes, mais qui reste un excellent spot de plong√©e comme de snorkeling. Les reliefs sous-marins y sont particuli√®rement vari√©s, avec une belle diversit√© de couleurs, d‚Äôesp√®ces et de structures rocheuses. La plage est constitu√©e de galets et la pente descend doucement jusqu‚Äô√† environ 30 m√®tres de profondeur, offrant un d√©cor grandiose m√™me depuis la surface. C‚Äôest tout simplement l‚Äôun des sites les plus beaux et les plus color√©s de la r√©gion, un incontournable pour les amateurs de fonds marins vibrants.",
          en: "A spot slightly exposed to Caribbean swell, yet still an excellent place for diving and snorkeling. The underwater reliefs are highly varied, with beautiful colors, species, and rocky structures. The beach is made of pebbles, and the slope drops gradually to around 30 meters, offering an impressive scenery even from the surface. One of the most beautiful and colorful sites in the region, a must for lovers of vibrant seascapes."
        },
        coords: [16.2527, -61.8043],
        rating: 4,
        species: ["tortue"],
        images: [
          "images/morphy1.JPG","images/morphy2.JPG","images/morphy3.JPG",
          "images/morphy4.JPG","images/morphy5.JPG","images/morphy6.JPG"
        ]
      },
      {
        name: {
          fr: "Plage de la R√©sidence D√©partementale, Le Gosier",
          en: "D√©partementale residence beach, Le Gosier"
        },
        desc: {
          fr: "Petite plage situ√©e au pied du fort. L‚Äôendroit est charmant et un peu escarp√©, mais la visibilit√© est tr√®s mauvaise : les vagues remuent constamment le sable, ce qui emp√™che toute observation sous-marine.",
          en: "A small beach located at the foot of the fort. The place is charming but visibility is very poor: waves constantly stir the sand, making underwater observation impossible."
        },
        coords: [16.2147, -61.5160],
        rating: 1,
        species: [],
        images: []
      },
      {
        name: {
          fr: "Plage de Bas-Du-Fort, Le Gosier",
          en: "Bas-du-Fort beach, Le Gosier"
        },
        desc: {
          fr: "Jolie plage touristique mais snorkeling limit√©. Une tr√®s belle plage, petite et souvent fr√©quent√©e par les visiteurs. L‚Äôeau y est bien prot√©g√©e, mais la visibilit√© reste faible et la biodiversit√© observ√©e est assez limit√©e. Un endroit agr√©able pour se baigner et profiter du cadre, mais pas vraiment adapt√© au snorkeling.",
          en: "Pretty tourist beach but limited snorkeling. A lovely, small and often busy beach. The water is well protected, but visibility remains low and biodiversity limited. A nice place for swimming and enjoying the setting, but not really suitable for snorkeling."
        },
        coords: [16.2138, -61.5240],
        rating: 2,
        species: [],
        images: []
      },
      {
        name: {
          fr: "Plage de Petit-Havre, Sainte-Anne",
          en: "Petit-Havre beach, Sainte-Anne"
        },
        desc: {
          fr: "Petit coin sauvage et convivial. Un lieu appr√©ci√© pour son c√¥t√© sauvage, les barbecues en bord de mer et un peu de surf selon les conditions. Quelques zones plus recul√©es offrent une visibilit√© correcte et permettent d‚Äôobserver quelques poissons, mais cela reste un petit spot de snorkeling, avec une richesse sous-marine limit√©e. Un endroit agr√©able pour profiter de l‚Äôambiance, plus que pour une exploration approfondie.",
          en: "A small wild and friendly spot. A place appreciated for its natural feel, seaside barbecues and occasional surfing depending on conditions. Some more remote areas offer decent visibility and a few fish, but it remains a small snorkeling site with limited underwater life. A pleasant spot for the atmosphere rather than for in-depth exploration."
        },
        coords: [16.2090, -61.4270],
        rating: 2,
        species: [],
        images: []
      },
      {
        name: {
          fr: "Anse Sainte-Marguerite, Le Moule",
          en: "Sainte-Marguerite cove, Le Moule"
        },
        desc: {
          fr: "Zone partiellement prot√©g√©e des vagues, mais qui devient vite impraticable voire dangereuse lorsque la houle est forte (ce qui est fr√©quent sur cette c√¥te). Plage assez rocheuse, relativement pollu√©e et peu adapt√©e au snorkeling. C‚Äôest surtout un tr√®s bel endroit pour se promener plut√¥t que pour observer les fonds marins.",
          en: "A partially wave-sheltered zone, but it quickly becomes impractical or even dangerous when the swell is strong (which is frequent on this coast). The beach is quite rocky, relatively polluted and poorly suited for snorkeling. It is mainly a beautiful place for walking rather than for exploring the seabed."
        },
        coords: [16.3893, -61.4049],
        rating: 1,
        species: [],
        images: []
      },
      {
        name: {
          fr: "Anse √† Sable, Bouillante",
          en: "Anse √† Sable, Bouillante"
        },
        desc: {
          fr: "Un spot sympathique situ√© non loin de la r√©serve Cousteau. Pour profiter pleinement de la biodiversit√©, il faut savoir descendre un peu en apn√©e ou longer la c√¥te, o√π l‚Äôon d√©couvre de jolies zones rocheuses et quelques esp√®ces int√©ressantes. L‚Äôensemble reste globalement joli et agr√©able, id√©al pour une petite exploration tranquille.",
          en: "A pleasant spot located not far from the Cousteau Reserve. To fully enjoy the biodiversity, you need to dive down a little or follow the coastline, where you‚Äôll find lovely rocky areas and interesting species. Overall, it‚Äôs a nice place for a quiet exploration."
        },
        coords: [16.1453, -61.7789],
        rating: 3,
        species: [],
        images: []
      },
      {
        name: {
          fr: "Pointe de l‚ÄôErmitage, Bouillante",
          en: "Hermitage point, Bouillante"
        },
        desc: {
          fr: "Le snorkeling y est int√©ressant, mais la houle peut rapidement pousser vers les rochers, rendant la zone potentiellement dangereuse. Ce n‚Äôest pas le meilleur spot de l‚Äô√Æle, mais il reste agr√©able et facilement accessible en bateau. √Ä privil√©gier par mer calme et avec une bonne vigilance.",
          en: "Snorkeling here is interesting, but the swell can quickly push you toward the rocks, making the area potentially dangerous. It‚Äôs not the best spot on the island, but it is still pleasant and easily accessible by boat. Best visited in calm seas and with good vigilance."
        },
        coords: [16.1260, -61.7752],
        rating: 2,
        species: [],
        images: []
      }
    ];

    /* ----------------------------------------------------------
       7. Marqueurs color√©s + popup avec photo
    ----------------------------------------------------------- */

    // Index courant de l'image pour chaque spot
    const currentImageIndex = spots.map(() => 0);

    const sliderIntervals = {}; // pour m√©moriser les setInterval par spot
    let lightboxSpotIndex = null;
    
    // Fonction appel√©e par les boutons ‚Äπ et ‚Ä∫ dans la popup
    function changeImage(spotIndex, direction) {
      const imgs = spots[spotIndex].images;
      if (!imgs || imgs.length === 0) return;

      const n = imgs.length;
      currentImageIndex[spotIndex] =
        (currentImageIndex[spotIndex] + direction + n) % n;

      const imgEl = document.getElementById(`slider-img-${spotIndex}`);
      const counterEl = document.getElementById(`slider-counter-${spotIndex}`);

      if (imgEl) {
        imgEl.src = imgs[currentImageIndex[spotIndex]];
      }
      if (counterEl) {
        counterEl.textContent = `${currentImageIndex[spotIndex] + 1} / ${n}`;
      }

      // si la lightbox est ouverte sur ce spot, on met aussi √† jour la grande image
      if (lightboxSpotIndex === spotIndex) {
        const bigImg = document.getElementById('lightbox-img');
        if (bigImg) {
          bigImg.src = imgs[currentImageIndex[spotIndex]];
        }
      }
    }

    function openLightbox(spotIndex) {
      const imgs = spots[spotIndex].images;
      if (!imgs || imgs.length === 0) return;

      lightboxSpotIndex = spotIndex;

      const bigImg = document.getElementById('lightbox-img');
      bigImg.src = imgs[currentImageIndex[spotIndex]];

      document.getElementById('lightbox').classList.remove('hidden');
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.add('hidden');
      lightboxSpotIndex = null;
    }

    function changeLightboxImage(direction) {
      if (lightboxSpotIndex === null) return;
      changeImage(lightboxSpotIndex, direction);  // r√©utilise la logique existante
    }

    // === G√©n√©rer la partie images (slider) de la popup, ind√©pendant de la langue ===
    function generateImagesHtml(spot, index) {
      if (!spot.images || spot.images.length === 0) return "";
      return `
        <div class="slider">
          <button type="button"
                  class="slider-btn"
                  onclick="changeImage(${index}, -1)">‚Äπ</button>
          <div class="slider-img-wrapper"
               onclick="openLightbox(${index})">
            <img id="slider-img-${index}"
                  src="${spot.images[0]}"
                  alt="${spot.name[currentLang] || spot.name}">
          </div>
          <button type="button"
                  class="slider-btn"
                  onclick="changeImage(${index}, 1)">‚Ä∫</button>
        </div>
        <div class="slider-counter"
              id="slider-counter-${index}">
              1 / ${spot.images.length}
        </div>
      `;
    }

    // === Appliquer la langue √† l‚Äôinterface ===
    function applyLanguage() {
      const t = i18n[currentLang];

      // 1) Mettre √† jour le texte du bouton "Filtres"
      const filtersTitleSpan = document.querySelector('#filters-toggle span');
      if (filtersTitleSpan) {
        filtersTitleSpan.textContent = t.filtersTitle;
      }

      // === üî• Mise √† jour des popups (titres + descriptions) ===
      spots.forEach((spot, index) => {
        const t = i18n[currentLang];
        
        const marker = spot._marker;

        const newPopupContent = `
          <b>${spot.name[currentLang]}</b><br>
          ${spot.desc[currentLang]}<br>
          Note : ${getStars(spot.rating)}<br><br>
          ${generateImagesHtml(spot, index)}
          <div class="popup-comments" id="comments-container-${index}">
            <button type="button"
                    class="comments-toggle"
                    data-spot-index="${index}">
              ${t.commentsToggleClosed}
            </button>
            <div class="comments-panel hidden">
              <div class="comments-hint">
                ${t.commentsTitle}
              </div>
            </div>
          </div>
        `;

        marker.bindPopup(newPopupContent);
        marker.options.title = spot.name[currentLang]; // important pour la recherche
      });

      // Texte du bouton "Changer de langue" dans le menu
      const langBtn = document.querySelector('.lang-button');
        if (langBtn) {
          langBtn.textContent = `üåê ${t.changeLanguage}`;
        }
      
      // === üî• Mise √† jour des fonds de carte ===
      // On retire l‚Äôancien contr√¥le
      if (layersControl) map.removeControl(layersControl);

      // On recr√©e baseLayers avec les bons noms
      baseLayers = {};
      baseLayers[t.mapLayers.satellite] = satellite;
      baseLayers[t.mapLayers.osm] = osm;
      baseLayers[t.mapLayers.relief] = relief;

      layersControl = L.control.layers(baseLayers, null, {
        collapsed: false
      }).addTo(map);

      // On replace le control dans le menu
      const layersContainer = layersControl.getContainer();
      document.getElementById('menu-baselayers').innerHTML = "";
      document.getElementById('menu-baselayers').appendChild(layersContainer);

      // 2) Mettre √† jour les labels des filtres
      const filtersContent = document.getElementById('filters-content');
      if (filtersContent) {
        const ratingCheckboxes = filtersContent.querySelectorAll('input[data-rating]');
        ratingCheckboxes.forEach(cb => {
          const rating = Number(cb.dataset.rating);
          // le texte du label est dans le n≈ìud texte apr√®s l‚Äôinput
          cb.parentElement.lastChild.textContent = ' ' + t.ratingTexts[rating];
        });

        const speciesCheckboxes = filtersContent.querySelectorAll('input[data-species]');
        speciesCheckboxes.forEach(cb => {
          const sp = cb.dataset.species;
          cb.parentElement.lastChild.textContent = ' ' + t.species[sp];
        });
      }

      // 3) Recr√©er la l√©gende dans la bonne langue
      if (legendControl) {
        map.removeControl(legendControl);
      }
      legendControl = L.control({ position: 'topright' });
      legendControl.onAdd = function () {
        const div = L.DomUtil.create('div', 'legend');
        const ratings = [5, 4, 3, 2, 1];

        div.innerHTML += "<b>" + t.legendTitle + "</b><br>";

        ratings.forEach(r => {
          div.innerHTML += `
            <i style="background:${getColor(r)};"></i>
            ${getStars(r)}<br>
          `;
        });

        return div;
      };
      legendControl.addTo(map);

      // 4) Mettre √† jour le placeholder de recherche
      if (searchControl && searchControl._input) {
        searchControl._input.placeholder = t.searchPlaceholder;
      }
    }
    
    spots.forEach((spot, index) => {

      const t = i18n[currentLang];
      
      let imagesHtml = "";
      if (spot.images && spot.images.length > 0) {
      imagesHtml = `
        <div class="slider">
          <button type="button"
                  class="slider-btn"
                  onclick="changeImage(${index}, -1)">‚Äπ</button>
          <div class="slider-img-wrapper"
               onclick="openLightbox(${index})">
            <img id="slider-img-${index}"
                  src="${spot.images[0]}"
                  alt="${spot.name}">
          </div>
          <button type="button"
                  class="slider-btn"
                  onclick="changeImage(${index}, 1)">‚Ä∫</button>
        </div>
        <div class="slider-counter"
              id="slider-counter-${index}">
              1 / ${spot.images.length}
        </div>
      `;
    }

      const popupContent = `
        <b>${spot.name[currentLang]}</b><br>
        ${spot.desc[currentLang]}<br>
        Note : ${getStars(spot.rating)}<br><br>
        ${generateImagesHtml(spot, index)}
        <div class="popup-comments" id="comments-container-${index}">
          <button type="button"
                  class="comments-toggle"
                  data-spot-index="${index}">
            ${t.commentsToggleClosed}
          </button>
          <div class="comments-panel hidden">
            <div class="comments-hint">
              ${t.commentsTitle}
            </div>
            <!-- Disqus sera d√©plac√© ici -->
          </div>
        </div>
      `;

      const icon = L.divIcon({
        className: `custom-marker rating-${spot.rating}`,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });

      // üëâ on cr√©e le marker, avec un "title" = nom du spot (utilis√© par le plugin de recherche)
      const marker = L.marker(spot.coords, {
        icon,
        title: spot.name[currentLang]
      }).bindPopup(popupContent);

      // üëâ on garde les infos sur le marker pour les filtres plus tard
      marker.rating = spot.rating;  // note associ√©e au marker
      spot._marker = marker;        // on stocke le marker dans l'objet spot
      marker.spotIndex = index;

      // üëâ on l‚Äôajoute au layer de markers (et donc √† la carte)
      markersLayer.addLayer(marker);
    });
    /* ----------------------------------------------------------
       8. L√©gende √©toiles + couleurs
    ----------------------------------------------------------- */
    

    // ----------------------------------------------------------
    // 9. Contr√¥le de recherche des spots
    // ----------------------------------------------------------
    searchControl = new L.Control.Search({
      layer: markersLayer,
      propertyName: 'title',
      marker: false,
      initial: false,
      zoom: 14,
      textPlaceholder: 'Rechercher un spot...',
      collapsed: false,
      position: 'topleft'
    });

    searchControl.on('search:locationfound', function (e) {
      if (e.layer._popup) {
        e.layer.openPopup();
      }
    });

    // On l‚Äôajoute √† la carte‚Ä¶
    map.addControl(searchControl);

    applyLanguage();

  // --- Auto-d√©filement des images + gestion UI + recentrage fixe ---
    map.on('popupopen', function (e) {
      // 1) cacher filtres / l√©gende / contr√¥les
      document.body.classList.add('popup-open');

      const marker = e.popup._source;
      const i = marker.spotIndex;

      // 2) Slider auto
      const imgs = spots[i].images;
      if (imgs && imgs.length > 1) {
        if (sliderIntervals[i]) {
          clearInterval(sliderIntervals[i]);
        }
        sliderIntervals[i] = setInterval(() => {
          changeImage(i, 1);
        }, 10000); // 10 s
      }

      // 3) Zoom fixe + d√©calage fixe
      const isMobile = window.innerWidth <= 768;

      // a) on force d‚Äôabord un zoom EXACT, identique pour tous
      const targetZoom = isMobile ? 13 : 13;
      map.setView(marker.getLatLng(), targetZoom, { animate: false });

      // b) on calcule la position en pixels √† CE zoom
      let p = map.project(marker.getLatLng(), targetZoom);

      // c) on applique un d√©calage vertical constant (en pixels d‚Äô√©cran)
      const offset = isMobile ? 180 : 180;  // ‚Üë augmente la valeur pour remonter la popup
      p.y -= offset;

      // d) nouvelle latitude/longitude correspondant √† cette position
      const finalLatLng = map.unproject(p, targetZoom);

      // e) et on anime pour aller √† cet endroit
      map.flyTo(finalLatLng, targetZoom, {
        animate: true,
        duration: 0.6
      });
      // --- üí¨ Gestion du bouton et de Disqus ---
      const popupEl = e.popup.getElement();
      const t = i18n[currentLang];
    
      const toggleBtn = popupEl.querySelector('.comments-toggle');
      const commentsPanel = popupEl.querySelector('.comments-panel');
      const disqusThread = document.getElementById('disqus_thread');
    
      if (toggleBtn && commentsPanel) {
        // ferm√© par d√©faut
        commentsPanel.classList.add('hidden');
        toggleBtn.textContent = t.commentsToggleClosed;
    
        toggleBtn.onclick = () => {
          const isHidden = commentsPanel.classList.toggle('hidden');
          toggleBtn.textContent = isHidden
            ? t.commentsToggleClosed
            : t.commentsToggleOpen;
        };
      }
    
      if (commentsPanel && disqusThread) {
        commentsPanel.appendChild(disqusThread);   // Disqus dans le panneau
        disqusThread.style.display = 'block';
    
        const spotId = 'spot-' + i;
        loadDisqusForSpot(spotId);
      }
    });
    
    map.on('popupclose', function (e) {
      // 1) on r√©-affiche filtres / l√©gende / contr√¥les
      document.body.classList.remove('popup-open');

      // 2) on coupe le slider auto
      const marker = e.popup._source;
      const i = marker.spotIndex;

      if (sliderIntervals[i]) {
        clearInterval(sliderIntervals[i]);
        delete sliderIntervals[i];
      }
      // üí¨ On remet Disqus dans le parking pour √©viter qu‚Äôil parte avec la popup
      const disqusThread = document.getElementById('disqus_thread');
      const parking = document.getElementById('disqus-parking');
      if (disqusThread && parking) {
        parking.appendChild(disqusThread);
        disqusThread.style.display = 'none';
      }
    });

    // --- Ouverture / fermeture du bloc filtres ---
    const filtersToggle = document.getElementById('filters-toggle');
    const filtersContent = document.getElementById('filters-content');
    const filtersArrow = document.querySelector('.filters-arrow');

    filtersToggle.addEventListener('click', () => {
      filtersContent.classList.toggle('hidden');
      filtersArrow.classList.toggle('open');
    });

    
    // ----------------------------------------------------------
    // 10. FILTRE PAR NOTE
    // ----------------------------------------------------------
    const checkboxes = document.querySelectorAll('#filters-box input[type="checkbox"]');

    checkboxes.forEach(cb => {
      cb.addEventListener('change', () => {

        // --- 1. Notes autoris√©es ---
        const allowedRatings = [...checkboxes]
          .filter(c => c.checked && c.dataset.rating)
          .map(c => Number(c.dataset.rating));

        // --- 2. Esp√®ces coch√©es ---
        const allowedSpecies = [...checkboxes]
          .filter(c => c.checked && c.dataset.species)
          .map(c => c.dataset.species);

        spots.forEach(spot => {
          const m = spot._marker;

          // --- Condition rating ---
          const ratingOK = allowedRatings.includes(spot.rating);

          // --- Condition esp√®ces ---
          let speciesOK = true;

          if (allowedSpecies.length > 0) {
            // le spot doit contenir toutes les esp√®ces coch√©es
            speciesOK = allowedSpecies.every(sp => spot.species.includes(sp));
          }

          // --- Affichage ou masquage ---
          if (ratingOK && speciesOK) {
            markersLayer.addLayer(m);
          } else {
            markersLayer.removeLayer(m);
          }
        });
      });
    });

  </script>
</body>
</html>
